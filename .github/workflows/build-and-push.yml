name: Build and Push Docker Images (Legacy)

# Bu workflow devre dÄ±ÅŸÄ± - GitOps iÃ§in update-values.yml kullanÄ±lÄ±yor
on:
  workflow_dispatch:  # Sadece manuel Ã§alÄ±ÅŸtÄ±rma
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main ]

env:
  DOCKER_USER: bakiakgun

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
      
    - name: Get commit hash
      id: commit
      run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKER_USER }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: ./task-tracker-backend
        push: true
        tags: |
          ${{ env.DOCKER_USER }}/task-tracker-backend:${{ steps.commit.outputs.hash }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./task-tracker-frontend
        push: true
        tags: |
          ${{ env.DOCKER_USER }}/task-tracker-frontend:${{ steps.commit.outputs.hash }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Create deployment summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit Hash:** \`${{ steps.commit.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend Image:** \`${{ env.DOCKER_USER }}/task-tracker-backend:${{ steps.commit.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Image:** \`${{ env.DOCKER_USER }}/task-tracker-frontend:${{ steps.commit.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deploy Commands:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`powershell" >> $GITHUB_STEP_SUMMARY
        echo "\$env:COMMIT_HASH = \"${{ steps.commit.outputs.hash }}\"" >> $GITHUB_STEP_SUMMARY
        echo "cd task-tracker-devops" >> $GITHUB_STEP_SUMMARY
        echo "docker compose -f docker-compose.template.yml up -d" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
    - name: Save deployment info
      run: |
        mkdir -p deployment
        echo "COMMIT_HASH=${{ steps.commit.outputs.hash }}" > deployment/latest.env
        echo "BACKEND_IMAGE=${{ env.DOCKER_USER }}/task-tracker-backend:${{ steps.commit.outputs.hash }}" >> deployment/latest.env
        echo "FRONTEND_IMAGE=${{ env.DOCKER_USER }}/task-tracker-frontend:${{ steps.commit.outputs.hash }}" >> deployment/latest.env
        
    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info-${{ steps.commit.outputs.hash }}
        path: deployment/
